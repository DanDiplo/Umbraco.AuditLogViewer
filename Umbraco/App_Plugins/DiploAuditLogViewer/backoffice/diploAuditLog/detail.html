<script>
    function AuditLogDetailController($scope, $routeParams, diploAuditLogResources, notificationsService) {

        $scope.logDetail = null;
        var id = $scope.dialogData.entry.Id;

        $("#audit-logdetail").parent("div").addClass('diplo-modal');

        var findInArray = function (array, value, offset) {
            for (var i = 0; i < array.length; i++) {

                console.log(array[i]["Id"], value);

                if (array[i]["Id"] == value) {
                    return array[i + offset];
                }
            }
            return null;
        }

        $scope.hasPrevious = function () {
            return $scope.dialogData.items[0].Id !== id;
        }

        $scope.hasNext = function () {
            return $scope.dialogData.items[$scope.dialogData.items.length - 1].Id !== id;
        }

        $scope.nextItem = function () {
            var next = findInArray($scope.dialogData.items, id, 1);
            if (next) {
                getLogDetail(next.Id);
            }
        }

        $scope.previousItem = function () {
            var prev = findInArray($scope.dialogData.items, id, -1);
            if (prev) {
                getLogDetail(prev.Id);
            }
        }

        $scope.getEditUrl = function () {
            return diploAuditLogResources.getEditUrl($scope.dialogData.entry);
        }

        function getLogDetail(id) {
            diploAuditLogResources.getLogDetail(id).then(function (data) {
                $scope.logDetail = data;
                $scope.dialogData.Id = data.Id;
            }, function (data) {
                notificationsService.error("Error", "Could not load log data: " + data);
            });
        };

        getLogDetail(id);

    }
</script>

<div class="umb-panel" ng-controller="AuditLogDetailController" id="audit-logdetail">

    <div class="umb-panel-header">
        <div class="row-fluid">
            <div class="span6">
                <h3>Log Data Detail<br /><small>{{logDetail.DateStamp}}</small></h3>
            </div>
            <div class="span6">
                <div class="btn-toolbar pull-right">
                    <a ng-click="previousItem()" class="btn" ng-show="hasPrevious()"><i class="icon-previous"></i>Previous</a>
                    <a ng-click="nextItem()" class="btn" ng-show="hasNext()">Next <i class="icon-next"></i></a>
                </div>
            </div>
        </div>

    </div>

    <div class="umb-panel-body umb-scrollable">
        <table class="table table-striped">

            <tbody>
                <tr>
                    <th>Action:</th>
                    <td>{{logDetail.LogType}}</td>
                </tr>
                <tr>
                    <th>Comment:</th>
                    <td>{{logDetail.Comment}}</td>
                </tr>
                <tr>
                    <th>Date:</th>
                    <td title="{{logDetail.DateStamp}}">{{logDetail.DateStamp | date:'fullDate'}} at {{logDetail.DateStamp | date:'mediumTime'}}</td>
                </tr>
                <tr>
                    <th>User:</th>
                    <td><small class="icon-out"></small> <a ng-href="#/users/framed/%252Fumbraco%252Fusers%252FeditUser.aspx%253Fid%253D{{logDetail.UserId}}" target="_blank" title="Edit User">{{logDetail.UserName}}</a> - <a title="Email" href="mailto:{{logDetail.UserEmail}}" target="_blank"> {{logDetail.UserEmail}}</a></td>
                </tr>
                <tr>
                    <th>Node:</th>
                    <td><span ng-show="logDetail.NodeId > 0"><small class="icon-out"></small> <a ng-href="{{getEditUrl()}}" target="_blank" title="Edit Node">{{logDetail.NodeId}}</a></span><span ng-show="logDetail.NodeId < 1">N/A</span></td>
                </tr>
                <tr ng-show="logDetail.Name">
                    <th>Content:</th>
                    <td> <a ng-show="pageUrl.length" title="View" ng-href="{{pageUrl}}" target="_blank" title="View"><small class="icon-out"></small> {{logDetail.Name}}</a> <span ng-hide="pageUrl.length">{{logDetail.Name}}</span></td>
                </tr>
                <tr ng-show="logDetail.Alias">
                    <th>DocType:</th>
                    <td title="{{logDetail.Description}}"><span class="{{logDetail.Icon}}"></span> {{logDetail.Alias}}</td>
                </tr>
            </tbody>

        </table>

    </div>
</div>

